version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  redis:
    image: redis:7-alpine
    container_name: fm-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  # ============================================================================
  # Backend Microservices
  # ============================================================================

  auth-service:
    image: faultmaven/fm-auth-service:latest
    container_name: fm-auth-service
    ports:
      - "${AUTH_PORT:-8001}:8001"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRE_MINUTES=${JWT_EXPIRE_MINUTES:-60}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      - DATABASE_URL=sqlite+aiosqlite:////data/fm_auth.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - auth-data:/data
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  session-service:
    image: faultmaven/fm-session-service:latest
    container_name: fm-session-service
    ports:
      - "${SESSION_PORT:-8002}:8002"
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  case-service:
    image: faultmaven/fm-case-service:latest
    container_name: fm-case-service
    ports:
      - "${CASE_PORT:-8003}:8003"
    environment:
      - DATABASE_URL=sqlite+aiosqlite:////data/fm_cases.db
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - FIREWORKS_API_KEY=${FIREWORKS_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - case-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  knowledge-service:
    image: faultmaven/fm-knowledge-service:latest
    container_name: fm-knowledge-service
    ports:
      - "${KNOWLEDGE_PORT:-8004}:8004"
    environment:
      - CHROMADB_PATH=/data/chromadb
      - DATABASE_URL=sqlite+aiosqlite:////data/fm_knowledge.db
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - FIREWORKS_API_KEY=${FIREWORKS_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - knowledge-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  evidence-service:
    image: faultmaven/fm-evidence-service:latest
    container_name: fm-evidence-service
    ports:
      - "${EVIDENCE_PORT:-8005}:8005"
    environment:
      - UPLOAD_DIR=/data/uploads
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-10}
      - MAX_FILES_PER_CASE=${MAX_FILES_PER_CASE:-20}
      - DATABASE_URL=sqlite+aiosqlite:////data/fm_evidence.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - evidence-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  # ============================================================================
  # API Gateway
  # ============================================================================

  gateway:
    image: faultmaven/fm-api-gateway:latest
    container_name: fm-api-gateway
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - FM_AUTH_URL=http://auth-service:8001
      - FM_SESSION_URL=http://session-service:8002
      - FM_CASE_URL=http://case-service:8003
      - FM_KNOWLEDGE_URL=http://knowledge-service:8004
      - FM_EVIDENCE_URL=http://evidence-service:8005
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:8000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - auth-service
      - session-service
      - case-service
      - knowledge-service
      - evidence-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - faultmaven-network

  # ============================================================================
  # Frontend - Dashboard
  # ============================================================================

  dashboard:
    image: faultmaven/faultmaven-dashboard:latest
    container_name: fm-dashboard
    ports:
      - "${DASHBOARD_PORT:-3000}:80"
    environment:
      - VITE_API_URL=http://localhost:${API_PORT:-8000}
    depends_on:
      - gateway
    restart: unless-stopped
    networks:
      - faultmaven-network

# ============================================================================
# Volumes for Data Persistence
# ============================================================================

volumes:
  redis-data:
    driver: local
  auth-data:
    driver: local
  case-data:
    driver: local
  knowledge-data:
    driver: local
  evidence-data:
    driver: local

# ============================================================================
# Networks
# ============================================================================

networks:
  faultmaven-network:
    driver: bridge
